name: E2E Tests

on:
  pull_request:

permissions:
  contents: read

jobs:
  run-e2e-tests:
    name: Run E2E Tests
    runs-on: [self-hosted, linux, X64, jammy, large]
    strategy:
      matrix:
        ginkgo_focus:
          #- "KCP remediation"
          #- "MachineDeployment remediation"
          - "Workload cluster creation"
          #- "Workload cluster scaling"
          #- "Workload cluster upgrade"
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Install requirements
        run: |
          sudo apt install make
          sudo apt install wget
      - name: Increase inotify watches
        run: |
          # Prevents https://cluster-api.sigs.k8s.io/user/troubleshooting#cluster-api-with-docker----too-many-open-files
          sudo sysctl fs.inotify.max_user_watches=1048576
          sudo sysctl fs.inotify.max_user_instances=8192
      - name: Run e2e tests
        run: |
          sudo -E ./hack/ci-e2e-tests.sh true aws v0.1.2
        env:
          GOPROXY: direct
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: us-east-2
